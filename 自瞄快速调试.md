# 自瞄快速调试

 创建于2024.7.13--李曾阳

**此份自瞄快速调试为简要步骤说明，在正常情况下可快速完成反小调试。重要的是不要只看这份调试，代码不是完美的，调试也是，要在源码中理解各个参数的意义和使用，效果不好要去理解为什么不好，注重看具体数据，不只是主观效果。**

自瞄代码常用参数文件均位于rmos_bringup/config文件夹内，对应节点参数以节点名开头，此文件夹参数均为使用declare_parameter函数读取，修改后无需重新编译。

注：相机内参文件除外，修改需重新编译生效。记得检测launch_params.yaml是否为实车模式

## 1、相机测试

确认相机焦距和光圈已合适且固定，可选择用电工胶布再在相机上缠绕固定。相机标定注意标定使用图像尺寸和实际使用图像尺寸。使用ros标定程序（https://github.com/IRobot-Algorithm/camera_calibration）或matlab进行相机内参标定，自行写入daheng_cam_info.yaml。

注意：更换相机参数后一定要重新编译才会生效！！！

## 2、通信延迟测试

在camera_params.yaml文件中修改time_offset值。测试方法：将云台无力，对准目标不动的装甲板，向右快速甩动云台（不要出相机视野），在rviz2中观察detectMarker中的装甲板，若为先向右再向左回到原位，则该值较小，应调大，若为先向左再向右回到原位，则该值较大，应调小。最终以晃动自身云台，对面装甲板位置变化很小且没有估计出线速度为成功。

## 3、装甲板检测调试

修改相机曝光和gain值，以良好识别慢速旋转装甲板和面对快速小陀螺ekf能够收敛为成功。（注：每次调试都应检查识别效果，也可修改detector中bin_threshold参数来修改二值化阈值，rqt接受二值化图像灯条应饱满）装甲板高亮代表灯条成功匹配为装甲板，拉出对角线则是成功完成数字分类。

## 4、弹道测试

用裁判系统查看当前弹速并填入processer的参数中。随后击打远处装甲板如6m处，调整yaw和pitch的offset使其击打到装甲板中心。随后击打各个位置和角度的装甲板看能否击中，通过调试bs_coeff和distance参数来实现微调。（注意：若有弹道或弹速不稳，要叫机械和电控来修弹道）

在保证能击打中的时候，在代码中judgeFire函数中打印出当前瞄准的装甲板在图像中的x坐标，并将其填入processer的true_x参数

## 5、反小陀螺测试

在rviz2中观察角速度能否稳定，若中心点或者角速度都不稳或收敛很慢就需要修改processer的ekf参数，一般修改r_xyz_factor和r_yaw即可，一般默认给的ekf参数就ok，先看是否曝光识别影响到此处解算效果。ekf预测正确后即可打弹测试，可用手机录慢动作查看击打效果，调试processer中的delay参数来调节预测时间。以自身静止打旋转小陀螺60%命中率，8s杀死300血步兵为基础。（注：若出现击打上下高低装甲板时枪口抬不动或抬过头。可以叫电控修改pid参数，让云台“硬”一点或“软”一点）

若射频过快或过慢可尝试修改judgeFire函数中fire_area的阈值。

## 6、平移靶测试

先观察枪口能否基本跟上平移目标，随后打弹测试。若跟不上或跟过头，可尝试修改源码中getAimingPoint函数中linear_change中预测时间中的时间偏执来强行跟上，随后打弹测试。

## 7、操作手测试

自身小陀螺下测试自瞄情况，可以让电控加前馈来辅助稳定云台

## 附

自瞄测试出现任何问题请及时记录到算法组Bug Lists中，并附上相关日志和截图，以及在算法组群中交流。https://w0ybodqyg7f.feishu.cn/wiki/NGv6wFslWiqJfwkIPUjcgYw9n3e?from=from_copylink

自启动文件：默认都放在home文件夹中的sh文件夹的watchdog.sh，注意赋权限，将其中gnome-terminal -e 'bash -c " xxxx "'改成自己的代码路径，在starup applications preferences中确认已添加相关自启动命令实例`gnome-terminal -e 'bash -c "/home/nuc/sh/watchdog.sh" '`，记得测试是否成功。

